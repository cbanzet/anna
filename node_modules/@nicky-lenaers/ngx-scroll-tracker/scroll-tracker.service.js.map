{"version":3,"sources":["../src/scroll-tracker.service.ts"],"names":[],"mappings":"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","file":"scroll-tracker.service.js","sourceRoot":"","sourcesContent":["import { Injectable, ElementRef, Renderer2 } from '@angular/core';\nimport { ReplaySubject, Observable } from 'rxjs';\nimport { ScrollTrackerEventData } from './models/scroll-tracker-event-data.model';\nimport { ScrollTrackerContainerManager } from './models/scroll-tracker-container-manager.model';\n\n\nexport class ScrollTrackerService {\n\n\tprivate _container_manager: ScrollTrackerContainerManager;\n\n\tconstructor() {\n\t\tthis._container_manager = new Map();\n\t}\n\n\t/**\n\t * Register a new Element to be tracked for scrolling.\n\t *\n\t * @param element_ref \t\t\tThe Element Reference\n\t * @param renderer2 \t\t\tThe Angular RendererV2\n\t * @returns \t\t\t\t\tAn RxJS Observable\n\t */\n\tpublic register(element_ref: ElementRef, renderer2: Renderer2): Observable<any> {\n\n\t\tlet container = this._getFirstScrollableParentNode(element_ref.nativeElement);\n\n\t\tif (!this._container_manager.has(container)) {\n\n\t\t\tthis._container_manager.set(container, {\n\t\t\t\tchildren: new Map(),\n\t\t\t\tlistener: (event) => this._isElementInContainerView(event, container)\n\t\t\t});\n\n\t\t\tconst container_listener = this._container_manager.get(container).listener;\n\n\t\t\trenderer2.listen(this._getListenerTarget(container), 'scroll', container_listener);\n\t\t\trenderer2.listen(this._getListenerTarget(container), 'resize', container_listener);\n\t\t}\n\n\t\t// Observable Element Source\n\t\tlet element_source$ = new ReplaySubject<ScrollTrackerEventData>();\n\n\t\t// Push Element to its Container\n\t\tthis._container_manager\n\t\t\t.get(container)\n\t\t\t.children\n\t\t\t.set(element_ref, element_source$);\n\n\t\t// Initial Test\n\t\tthis._isElementInContainerView(new Event('ngx-scroll-tracker-initial-event'), container);\n\n\t\t// Return Observable\n\t\treturn element_source$.asObservable();\n\t}\n\n\t/**\n\t * Retrieves the Listener target.\n\t *\n\t * @param container \t\t\t\tThe HTML Container Element\n\t * @returns \t\t\t\t\t\tThe Listener Object\n\t */\n\tprivate _getListenerTarget(container: HTMLElement): HTMLElement | Window {\n\t\treturn container.tagName === 'BODY' ? window : container;\n\t}\n\n\t/**\n\t * Evaluate whether the registered Element is in the view or not.\n\t *\n\t * @param container \t\t\t\tThe Container the Element belongs to\n\t * @returns void\n\t */\n\tprivate _isElementInContainerView(event: Event, container: HTMLElement): void {\n\n\t\tlet container_rect: ClientRect = container.getBoundingClientRect();\n\n\t\tthis._container_manager.get(container).children.forEach((child_value, child_key, map) => {\n\n\t\t\t// Set Element Rectangle\n\t\t\tlet element_rect: ClientRect = child_key.nativeElement.getBoundingClientRect();\n\t\t\tconst element_height = element_rect.bottom - element_rect.top;\n\n\t\t\t// Set Container Height and Top\n\t\t\tconst container_height = this._isWindow(this._getListenerTarget(container)) ? window.innerHeight : (container_rect.bottom - container_rect.top);\n\t\t\tconst container_top = this._isWindow(this._getListenerTarget(container)) ? 0 : container_rect.top;\n\n\t\t\t// Set Event Data\n\t\t\tlet event_data: ScrollTrackerEventData = {\n\t\t\t\t$event: event,\n\t\t\t\telementRef: child_key,\n\t\t\t\tdata: {\n\t\t\t\t\telementTop: {\n\t\t\t\t\t\tfromContainerTop: {\n\t\t\t\t\t\t\tpixels: element_rect.top - container_top,\n\t\t\t\t\t\t\tratio: (element_rect.top - container_top) / container_height\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfromContainerBottom: {\n\t\t\t\t\t\t\tpixels: element_rect.top - (container_height + container_top),\n\t\t\t\t\t\t\tratio: (element_rect.top - (container_height + container_top)) / container_height\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\telementBottom: {\n\t\t\t\t\t\tfromContainerTop: {\n\t\t\t\t\t\t\tpixels: (element_rect.top + element_height) - container_top,\n\t\t\t\t\t\t\tratio: ((element_rect.top + element_height) - container_top) / container_height\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfromContainerBottom: {\n\t\t\t\t\t\t\tpixels: (element_rect.top + element_height) - (container_height + container_top),\n\t\t\t\t\t\t\tratio: ((element_rect.top + element_height) - (container_height + container_top)) / container_height\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Emit Value\n\t\t\tthis._container_manager\n\t\t\t\t.get(container)\n\t\t\t\t.children\n\t\t\t\t.get(child_key)\n\t\t\t\t.next(event_data);\n\t\t});\n\t}\n\n\t/**\n\t * Test if a given Element is the Window.\n\t *\n\t * @param container \t\t\t\tThe given Element\n\t * @returns \t\t\t\t\t\tBoolean if given Element is Window\n\t */\n\tprivate _isWindow(container: HTMLElement | Window): container is Window {\n\t\treturn container === window;\n\t}\n\n\t/**\n\t * Find the first scrollable parent node of an element.\n\t *\n\t * @param nativeElement \t\t\tThe element to search from\n\t * @param includeHidden \t\t\tWhether to include hidden elements or not\n\t * @returns \t\t\t\t\t\tThe first scrollable parent node\n\t */\n\tprivate _getFirstScrollableParentNode(nativeElement: HTMLElement, includeHidden: boolean = true): HTMLElement {\n\n\t\tlet style: CSSStyleDeclaration = window.getComputedStyle(nativeElement);\n\n\t\tconst overflow_regex: RegExp = includeHidden ? /(auto|scroll|hidden)/ : /(auto|scroll)/;\n\n\t\tif (style.position === 'fixed') throw new Error(`Scroll item cannot be positioned 'fixed'`);\n\n\t\t// Recursive Loop Parents\n\t\tfor (let parent = nativeElement; parent = parent.parentElement;) {\n\n\t\t\t// Recalculate Style\n\t\t\tstyle = window.getComputedStyle(parent);\n\n\t\t\t// Skip Absolute Positioning\n\t\t\tif (style.position === 'absolute') continue;\n\n\t\t\t// Return Body\n\t\t\tif (parent.tagName === 'BODY') return parent;\n\n\t\t\t// Test Overflow\n\t\t\tif (overflow_regex.test(style.overflow + style.overflowY + style.overflowX)) return parent;\n\t\t}\n\n\t\tthrow new Error(`No scrollable parent found for element ${nativeElement}`);\n\t}\n\n\t/**\n\t * Unregisters an Element from being tracked for scrolling.\n\t *\n\t * @param element  \t\t\tThe Element to unregister\n\t * @returns void\n\t */\n\tprivate _unregister(element: ElementRef): void {\n\n\t\tthis._container_manager.forEach((container_value, container_key, container_map) => {\n\n\t\t\tcontainer_value.children.forEach((child_value, child_key, element_map) => {\n\n\t\t\t\tif (child_key.nativeElement === element.nativeElement) {\n\n\t\t\t\t\t// Remove Element from Container\n\t\t\t\t\tthis._container_manager.get(container_key).children.delete(child_key);\n\n\t\t\t\t\t// No more Element to be tracked\n\t\t\t\t\tif (this._container_manager.get(container_key).children.size === 0) {\n\n\t\t\t\t\t\t// Cleanup\n\t\t\t\t\t\tthis._container_manager.delete(container_key);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}